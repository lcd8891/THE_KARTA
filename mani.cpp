#include "header.hpp"
#include "translate.hpp"
#include "resources.hpp"
#include <cmath>
#include <SFML/System.hpp>
#include <sstream>
ничего меню();
ничего информация();
ничего карта();

#define НАДО_КОРДЫ 

#define П2 1.57 

unsigned кадр = 0;
sf::Vector2f относительная;
sf::Vector2f кнопка_относительная;
bool ззакрыть = false;
unsigned текст_по_символу = 0;
стринги стр,кгоро_назва;
sf::Clock часик_ёпта;
unsigned колво_мест{0},место{0};

#ifdef НАДО_КОРДЫ
ничего получить_коорды(const sf::Event &event){
    if(event.type == sf::Event::KeyReleased && event.key.code == sf::Keyboard::Space){
        sf::Vector2i ф = sf::Mouse::getPosition(window);
        sf::Vector2i ь = {
            (ф.x - 372) / 536.f * 100, 
            (ф.y - 55) / 536.f * 100
        };
        уведомить(L"Нажатие было произведено в "+std::to_wstring(ь.x)+L" "+std::to_wstring(ь.y));
    }
}
#endif

стринги обработка(const стринги& стр, const unsigned макс) {
    стринги результат;
    unsigned текущая_длина = 0;
    
    for (size_t i = 0; i < стр.length(); ++i) {
        wchar_t c = стр[i];
        if (c == L'\n') {
            результат += c;
            текущая_длина = 0;
            continue;
        }
        if (текущая_длина >= макс) {
            size_t последний_пробел = результат.find_last_of(L' ', результат.length() - текущая_длина);
            if (последний_пробел != стринги::npos && последний_пробел > результат.length() - текущая_длина) {
                результат[последний_пробел] = L'\n';
                текущая_длина = результат.length() - последний_пробел - 1;
            } else {
                результат += L'\n';
                текущая_длина = 0;
            }
        }
        результат += c;
        текущая_длина++;
    }
    return результат;
}

ничего открыть_просмотр(){
    window.clear(sf::Color::White);
    float процентаг = sin( ( кадр / 30.f) * П2);
    unsigned char ы = 255.f * процентаг;
    спрайт(2,относительная * процентаг);
    спрайт(3,кнопка_относительная + относительная * процентаг,true);
    пишем(кгоро_назва,(кнопка_относительная + относительная * процентаг) + sf::Vector2f(10,20));
    прикольная_линия(кнопка_относительная + относительная * процентаг,{600,100},{0,0,0,0},{0,0,0,ы});
    прикольная_линия({600,100},{600,500},{0,0,0,ы},{0,0,0,ы});
    спрайт(зе_карта.картинка_1,{640,50},{255,255,255,ы});
    спрайт(зе_карта.картинка_2,{940,50},{255,255,255,ы});
    if(кадр!=30 && !ззакрыть){
        кадр++;
    }else if(ззакрыть && кадр!=0){
        кадр--;
    }
    if(часик_ёпта.getElapsedTime().asMilliseconds() >= 30 && текст_по_символу < стр.size()){
        текст_по_символу++;
        часик_ёпта.restart();
        включить_звук(1);
    }
    стринги темстр = стр .substr(0,текст_по_символу);
    пишем(темстр,{640,350},0,{255,255,255,ы},42);
    пишем(L"Закрыть",{540,600},1,{255,255,255,ы},32);
    пишем(L"Нажмите клавишы ВЛЕВО/ВПРАВО для переключения страниц.",{640,680},1,{255,255,255,ы},32);
    if(колво_мест!=0)пишем(std::to_wstring(место+1)+L"/"+std::to_wstring(колво_мест+1),{920,20},1,{255,255,255,ы},32);
    if(ззакрыть && кадр==0){
        добавить_кнопку("back",{50,20},{100,30});
        зе_карта.прогрузить_кнопки();
        указатель = карта;
        #ifdef НАДО_КОРДЫ
        ещё_указатель = получить_коорды;
        #else
        ещё_указатель = [](const sf::Event &event) {};
        #endif
    }
    if(кнопка_нажата("back to map")){
        ззакрыть = true;
        забыть_кнопки();
    }
}

ничего карта(){
    window.clear(sf::Color::White);
    if(кнопка_нажата("back")){
        забыть_кнопки();
        указатель = меню;
        добавить_кнопку("start",{640,360},{500,30});
        добавить_кнопку("info",{640,400},{500,30});
        добавить_кнопку("exit",{640,440},{500,30});
        включить_хит("firefly");
        #ifdef НАДО_КОРДЫ
        ещё_указатель = [](const sf::Event &event) {};
        #endif
    }
    строка кнопка = какая_кнопка_нажата();
    if(кнопка != "back" && !кнопка.empty()){
        стринги a,b,тмп;
        относительная = зе_карта.загрузить_город(кнопка,колво_мест,кнопка_относительная,кгоро_назва);
        место = 0;
        зе_карта.загрузить_место(место,a,b);
        тмп = b + L"\n" + a;
        стр = обработка(тмп,40);
        указатель = открыть_просмотр;
        забыть_кнопки();
        добавить_кнопку("back to map",{540,600},{100,30});
        ззакрыть = false;
        текст_по_символу = 0;
        if(колво_мест!=0){
            ещё_указатель = [](const sf::Event &event) {
                if(event.type == sf::Event::KeyPressed){
                    if(event.key.code == sf::Keyboard::Left && место > 0){
                        место--;
                        стринги a,b,тмп;
                        зе_карта.загрузить_место(место,a,b);
                        тмп = b + L"\n" + a;
                        стр = обработка(тмп,40);
                        текст_по_символу = 0;
                    }else if(event.key.code == sf::Keyboard::Right && место < колво_мест){
                        место++;
                        стринги a,b,тмп;
                        зе_карта.загрузить_место(место,a,b);
                        тмп = b + L"\n" + a;
                        стр = обработка(тмп,40);
                        текст_по_символу = 0;
                    }
                }
            };
        }
    }
    спрайт(2,{0,0});
    пишем(L"< меню",{10,20},0);
    пишем(L"Нажмите на кнопку.png, чтобы посмотреть",{640,660},1,sf::Color::White,48);
    зе_карта.рисовать_пины();
}
ничего текст_загрузки(){
    window.clear(sf::Color::Black);
    пишем_некрасиво(L"Чёто грузим...",{640,360},1);
    стринги ы = std::to_wstring((int)(процент*100))+L" проценты";
    пишем_некрасиво(ы,{640,400},1);
}
ничего меню(){
    if(кнопка_нажата("start")){
        забыть_кнопки();
        добавить_кнопку("back",{50,20},{100,30});
        зе_карта.прогрузить_кнопки();
        включить_хит(музыки[число_загаданное_небесами]);
        указатель = карта;
        #ifdef НАДО_КОРДЫ
        ещё_указатель = получить_коорды;
        #endif
    }
    if(кнопка_нажата("info")){
        забыть_кнопки();
        добавить_кнопку("vse yasno",{640,680},{100,30});
        включить_хит("info");
        указатель = информация;
    }
    if(кнопка_нажата("exit")){
        уведомить(L"Функция ВЫХОД пока что находится в разработке.");
    }
    спрайт(0,{0,0});
    пишем(L"интерактивная карта беларуси",{640,20},1,sf::Color::White,64);
    пишем(L"начать",{640,360},1);
    пишем(L"информация",{640,400},1);
    пишем(L"выход",{640,440},1);
}
ничего информация(){
    if(кнопка_нажата("vse yasno")){
        забыть_кнопки();
        указатель = меню;
        добавить_кнопку("start",{640,360},{500,30});
        добавить_кнопку("info",{640,400},{500,30});
        добавить_кнопку("exit",{640,440},{500,30});
        включить_хит("firefly");
    }
    спрайт(1,{0,0});
    пишем(L"Разработано by Радченко Владиславом 100МНЕ.",{100,200},0,sf::Color::White,64);
    пишем(L"Сделано на C++ полностью на русском языке с \nиспользованием молитв.",{100,270},0,sf::Color::White,64);
    пишем(L"Всё ясно",{640,680},1);
}

цифорка главная(){
    меню_указатель=меню;

    ещё_указатель = [](const sf::Event &event) {};

    указатель = текст_загрузки;

    сделать_магию();
    начать_cycles();
    return ВСЁ_КРУТО;
}